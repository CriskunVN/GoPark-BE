// functions/statisticsFunctions.js
import Booking from "../../../models/booking.model.js";
import Vehicle from "../../../models/vehicles.model.js";
import ParkingLot from "../../../models/parkinglot.model.js";
import User from "../../../models/user.model.js";

export async function getUserStats(userId) {
  try {
    console.log(`üìä Getting user stats for: ${userId}`);
    
    const [bookingCount, vehicleCount, activeBookings, totalSpent] = await Promise.all([
      // T·ªïng s·ªë booking
      Booking.countDocuments({ userId }),
      
      // S·ªë l∆∞·ª£ng xe ƒë√£ ƒëƒÉng k√Ω
      Vehicle.countDocuments({ userId }),
      
      // Booking ƒëang active
      Booking.countDocuments({ 
        userId, 
        status: { $in: ['pending', 'confirmed'] } 
      }),
      
      // T·ªïng chi ti√™u (t·ª´ c√°c booking completed)
      Booking.aggregate([
        { 
          $match: { 
            userId: mongoose.Types.ObjectId(userId),
            status: 'completed'
          } 
        },
        {
          $group: {
            _id: null,
            total: { $sum: '$totalPrice' }
          }
        }
      ])
    ]);

    return {
      bookingCount,
      vehicleCount, 
      activeBookings,
      totalSpent: totalSpent.length > 0 ? totalSpent[0].total : 0
    };
  } catch (error) {
    console.error('‚ùå Error in getUserStats:', error);
    throw new Error('Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™ ng∆∞·ªùi d√πng');
  }
}

export async function getOwnerRevenue(userId) {
  try {
    console.log(`üí∞ Getting owner revenue for: ${userId}`);
    
    // L·∫•y t·∫•t c·∫£ b√£i xe c·ªßa ch·ªß n√†y
    const parkingLots = await ParkingLot.find({ parkingOwner: userId });
    const parkingLotIds = parkingLots.map(lot => lot._id);
    
    // L·∫•y doanh thu t·ª´ c√°c booking trong b√£i xe c·ªßa ch·ªß
    const revenueStats = await Booking.aggregate([
      {
        $lookup: {
          from: 'parkingslots',
          localField: 'parkingSlotId',
          foreignField: '_id',
          as: 'parkingSlot'
        }
      },
      {
        $unwind: '$parkingSlot'
      },
      {
        $match: {
          'parkingSlot.parkingLot': { $in: parkingLotIds }
        }
      },
      {
        $group: {
          _id: null,
          totalRevenue: { $sum: '$totalPrice' },
          totalBookings: { $sum: 1 },
          completedBookings: {
            $sum: { $cond: [{ $eq: ['$status', 'completed'] }, 1, 0] }
          }
        }
      }
    ]);

    return {
      parkingLotCount: parkingLots.length,
      totalRevenue: revenueStats.length > 0 ? revenueStats[0].totalRevenue : 0,
      totalBookings: revenueStats.length > 0 ? revenueStats[0].totalBookings : 0,
      completedBookings: revenueStats.length > 0 ? revenueStats[0].completedBookings : 0
    };
  } catch (error) {
    console.error('‚ùå Error in getOwnerRevenue:', error);
    throw new Error('Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™ doanh thu');
  }
}

export async function getAdminStats(userId) {
  try {
    console.log(`üëë Getting admin stats for: ${userId}`);
    
    // Verify user is actually admin
    const user = await User.findById(userId);
    if (!user || user.role !== 'admin') {
      throw new Error('Kh√¥ng c√≥ quy·ªÅn admin');
    }

    const [totalUsers, totalOwners, totalParkingLots, totalBookings, revenueStats] = await Promise.all([
      User.countDocuments({ role: 'user' }),
      User.countDocuments({ role: 'parking_owner' }),
      ParkingLot.countDocuments(),
      Booking.countDocuments(),
      Booking.aggregate([
        {
          $match: { status: 'completed' }
        },
        {
          $group: {
            _id: null,
            totalRevenue: { $sum: '$totalPrice' }
          }
        }
      ])
    ]);

    return {
      totalUsers,
      totalOwners, 
      totalParkingLots,
      totalBookings,
      totalRevenue: revenueStats.length > 0 ? revenueStats[0].totalRevenue : 0
    };
  } catch (error) {
    console.error('‚ùå Error in getAdminStats:', error);
    throw new Error('Kh√¥ng th·ªÉ l·∫•y th·ªëng k√™ h·ªá th·ªëng');
  }
}

// Gi·ªØ l·∫°i functions c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch
export async function getParkingRevenue(userId, parkingLotId, timeRange) {
  // Implementation c≈©...
}

export async function getSystemStats(userId, statType, timeRange) {
  // Implementation c≈©...
}